node {
	try {
		stage('Checkout') {
			echo 'Checkout'
			checkout scm
			sh 'git clean -dfx'
		}

		dir('service-1') {	
			stage('Build') {
				env.PATH = "${tool 'gradle'}/bin:${env.PATH}"
				sh 'gradle build'
			}
			
			stage('Deploy') {
				sh 'ssh matthias@jenkinslab-deployserver "ps aux | grep service-1-0.0.1-SNAPSHOT.jar | awk \'{print $2}\' | xargs kill -9 || true"'
				sh 'scp build/libs/service-1-0.0.1-SNAPSHOT.jar startup.sh shutdown.sh matthias@jenkinslab-deployserver:~/jenkinslab/service-1/'
				sh 'ssh matthias@jenkinslab-deployserver chmod -R 755 jenkinslab/service-1'
				sh 'ssh matthias@jenkinslab-deployserver "nohup java -jar jenkinslab/service-1/service-1-0.0.1-SNAPSHOT.jar --server.port=9090 &"'
			}
			
			stage('Healthcheck') {
				retry(5) {
					sleep time: 10, units: 'SECONDS'
					def response = httpRequest 'http://jenkinslab-deployserver:9090/health'
					if (!response.content.contains('"status":"UP"')) {
						error('alive check failed: $(response.content)')
					}
				}
			}
		}
	}
	catch (exc) {
		echo "Caught: ${exc}"
		currentBuild.result = 'FAILURE'
	}
}
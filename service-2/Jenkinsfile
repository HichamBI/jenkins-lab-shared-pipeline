node {
    try {
        stage('Checkout') {
            git url: 'https://github.com/comsysto/jenkins-lab-shared-pipeline.git', credentialsId: 'GITHUB_CRED'
        }

        dir('service-2') {

            stage('Build') {
                sh './gradlew clean build'
            }

            stage('Deploy') {
                def jenkinsSshCredentialsId = 'VAGRANT-SSH'
                def jarName = 'service-2-0.0.1-SNAPSHOT.jar'
                def serverUsername = 'vagrant'
                def serverHostname = '192.168.33.10'
                def serverPort = '9090'
                def serverDeploymentPath = '~/jenkinslab/service-2/'

                httpRequest url: "http://${serverHostname}:${serverPort}/shutdown", httpMode: 'POST', validResponseCodes: '200,408,404'
                sshagent(credentials: [jenkinsSshCredentialsId]) {
                    sh "ssh ${serverUsername}@${serverHostname} \"mkdir -p ${serverDeploymentPath}\""
                    sh "scp build/libs/${jarName} ${serverUsername}@${serverHostname}:${serverDeploymentPath}"
                    sh "ssh ${serverUsername}@${serverHostname} \"nohup java -jar ${serverDeploymentPath}${jarName} --server.port=${serverPort}\" &"
                }
            }



        }
    } catch (exc) {
        echo "Caught: ${exc}"
        currentBuild.result = 'FAILURE'
    }
}